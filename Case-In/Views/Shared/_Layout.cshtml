<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/jquery")
</head>
<body>
    @RenderBody()


    <table id="tabl_msgses">
        <tbody id="spisochk">

        </tbody>
    </table>


    <div class="groups_message">
        <input id="text_message" type="text" size="40">
        <input id="button_message" type="submit" value="Отправить">
    </div>

    <script>
        var my_masage_styl = "my_msg";
        var bot_msg_styl = "bot_msg";
        var bot_msg_button_styl = "bot_msg_button";
        var bot_masg_link_styl = "bot_masg_link";
        var bot_masg_image_styl = "bot_masg_image";

        function showButtons(dataCommand, nameCommand, paramCommand) {
            let trss = document.createElement('tr');
            let input = document.createElement('input');
            input.className = "bot_msg_button";
            input.type = "submit";
            input.id = dataCommand;
            input.value = nameCommand;
            if (paramCommand !== null)
                input.name = paramCommand;
            trss.append(input);
            document.getElementById("spisochk").append(trss);
        }

        function getListCommand() {
            var json;
            $.ajax({
                url: 'http://c1997e2b1dd1.ngrok.io/api/GetCommandList',
                type: 'GET',
                dataType: 'html',
                async: false,
                success: function (msg) {
                    json = msg;
                }
            });
            var obj = $.parseJSON(json);
            obj.forEach(function (entry) {
                showButtons(entry.dataCommand, entry.nameCommand, entry.paramCommand);
            });
        }

        getListCommand();

        function showMessg(msgsses, class_name) {
            let trss = document.createElement('tr');
            let div = document.createElement('td');
            div.className = class_name;
            div.innerHTML = msgsses;
            trss.append(div);
            document.getElementById("spisochk").append(trss);

            var curPos = $(document).scrollTop();
            var height = $("body").height();
            var scrollTime = (height - curPos) / 1.73;
            $("body,html").animate({ "scrollTop": height }, scrollTime);
        }

        function textProcces(text) {
            var msg;
            switch (text.type) {
                case 'img':
                    msg = '<img src="' + text.data + '" />';
                    break;
                case 'link':
                    msg = '<a href="' + text.data + '"><b>' + text.alias + '</b></a>';
                    break;
                case 'text':
                    msg = '<b>' + text.alias + "&nbsp;" + '</b>' + text.data;
                    break;
                default:
                    msg = '<b>' + text + '<b>';
                    break;
            }
            return msg + '<br><br>';
        }

        function sendRequest(dataCommand, paramCommand) {
            var req = '{ "mainCommand": "' + dataCommand + '",' + '"param": "' + paramCommand + '"}';
            var json;
            $.ajax({
                url: 'http://c1997e2b1dd1.ngrok.io/api/Main?json=' + req,
                type: 'post',
                dataType: 'html',
                async: false,
                success: function (msg) {
                    json = msg;
                    document.getElementById("button_message").onclick = function () {
                        showMessg(document.getElementById("text_message").value, my_masage_styl);
                    }
                }
            });
            var obj = $.parseJSON(json);
            var text = "";
            if (obj.errorMes !== null) {
                showMessg(obj.errorMes, bot_msg_styl);
            }
            if (obj.listData !== null) {
                obj.listData.forEach(function (data) {
                    text = text + textProcces(data);
                });
                var texts = '<text>' + text.substr(0, text.length - 8) + '</text>';
                showMessg(texts, bot_msg_styl);
            }
            if (obj.listCommand !== null) {
                obj.listCommand.forEach(function (data) {
                    let trss = document.createElement('tr');
                    let input = document.createElement('input');
                    input.className = "bot_msg_button";
                    input.type = "submit";
                    input.id = data.dataCommand + data.paramCommand;
                    input.value = data.nameCommand;
                    if (data.paramCommand !== null)
                        input.name = data.paramCommand;
                    trss.append(input);
                    document.getElementById("spisochk").append(trss);
                    document.getElementById(data.dataCommand + data.paramCommand).onclick = function () {
                        sendRequest(data.dataCommand, data.paramCommand);
                        document.getElementById(data.dataCommand + data.paramCommand).remove();
                    }
                });
                
            }
        }

        document.getElementById("button_message").onclick = function () {
            showMessg(document.getElementById("text_message").value, my_masage_styl);
        }

        var text = document.getElementById("text_message");
        var RegulationsDocs = document.getElementById("RegulationsDocs");
        var CompanyOffices = document.getElementById("CompanyOffices");
        var CompanyOfficesInfo = document.getElementById("CompanyOfficesInfo");
        var CultureInfo = document.getElementById("CultureInfo");
        var UserInfo = document.getElementById("UserInfo");

        RegulationsDocs.onclick = function () { sendRequest(RegulationsDocs.id, null); };
        CompanyOffices.onclick = function () { sendRequest(CompanyOffices.id, null); };
        CultureInfo.onclick = function () { sendRequest(CultureInfo.id, CultureInfo.name); };
        CompanyOfficesInfo.onclick = function () {
            showMessg("Введите " + CompanyOfficesInfo.name.toLowerCase(), bot_msg_styl);
            document.getElementById("button_message").onclick = function () {
                sendRequest(CompanyOfficesInfo.id, text.value);
            }
        };
        UserInfo.onclick = function () {
            showMessg("Введите " + UserInfo.name.toLowerCase(), bot_msg_styl);
            document.getElementById("button_message").onclick = function () {
                sendRequest(UserInfo.id, text.value);
            }
        };
    </script>


    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)
</body>
</html>
